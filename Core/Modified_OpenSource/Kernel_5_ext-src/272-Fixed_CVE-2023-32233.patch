--- linux_patch271/include/net/netfilter/nf_tables.h	2023-08-17 13:06:58.247328393 +0800
+++ linux/include/net/netfilter/nf_tables.h	2023-08-17 13:08:45.383154279 +0800
@@ -493,6 +493,7 @@
 };
 
 enum nft_trans_phase;
+void nf_tables_activate_set(const struct nft_ctx *ctx, struct nft_set *set);
 void nf_tables_deactivate_set(const struct nft_ctx *ctx, struct nft_set *set,
 			      struct nft_set_binding *binding,
 			      enum nft_trans_phase phase);
--- linux_patch271/net/netfilter/nf_tables_api.c	2023-08-17 13:06:57.371329649 +0800
+++ linux/net/netfilter/nf_tables_api.c	2023-08-17 13:12:36.174667837 +0800
@@ -3919,6 +3919,15 @@
 	}
 }
 
+void nf_tables_activate_set(const struct nft_ctx *ctx, struct nft_set *set)
+{
+       if (nft_set_is_anonymous(set))
+               nft_clear(ctx->net, set);
+
+       set->use++;
+}
+EXPORT_SYMBOL_GPL(nf_tables_activate_set);
+
 void nf_tables_deactivate_set(const struct nft_ctx *ctx, struct nft_set *set,
 			      struct nft_set_binding *binding,
 			      enum nft_trans_phase phase)
--- linux_patch271/net/netfilter/nft_dynset.c	2023-08-17 13:06:57.371329649 +0800
+++ linux/net/netfilter/nft_dynset.c	2023-08-17 13:13:34.170527156 +0800
@@ -259,7 +259,7 @@
 {
 	struct nft_dynset *priv = nft_expr_priv(expr);
 
-	priv->set->use++;
+	nf_tables_activate_set(ctx, priv->set);
 }
 
 static void nft_dynset_destroy(const struct nft_ctx *ctx,
--- linux_patch271/net/netfilter/nft_lookup.c	2023-08-17 13:06:57.371329649 +0800
+++ linux/net/netfilter/nft_lookup.c	2023-08-17 13:14:43.586351106 +0800
@@ -129,7 +129,7 @@
 {
 	struct nft_lookup *priv = nft_expr_priv(expr);
 
-	priv->set->use++;
+	nf_tables_activate_set(ctx, priv->set);
 }
 
 static void nft_lookup_destroy(const struct nft_ctx *ctx,
--- linux_patch271/net/netfilter/nft_objref.c	2023-08-17 13:06:57.371329649 +0800
+++ linux/net/netfilter/nft_objref.c	2023-08-17 13:15:39.550203770 +0800
@@ -180,7 +180,7 @@
 {
 	struct nft_objref_map *priv = nft_expr_priv(expr);
 
-	priv->set->use++;
+	nf_tables_activate_set(ctx, priv->set);
 }
 
 static void nft_objref_map_destroy(const struct nft_ctx *ctx,
