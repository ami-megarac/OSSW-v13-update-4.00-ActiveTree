diff -Naur linux_org/net/ipv6/ipv6_sockglue.c linux/net/ipv6/ipv6_sockglue.c
--- linux_org/net/ipv6/ipv6_sockglue.c	2022-12-20 16:19:10.580216498 +0800
+++ linux/net/ipv6/ipv6_sockglue.c	2022-12-20 16:22:00.732124621 +0800
@@ -164,6 +164,12 @@
 		rtnl_lock();
 	lock_sock(sk);
 
+	/* Another thread has converted the socket into IPv4 with
+	 * IPV6_ADDRFORM concurrently.
+	 */
+	if (unlikely(sk->sk_family != AF_INET6))
+		goto unlock;
+
 	switch (optname) {
 
 	case IPV6_ADDRFORM:
@@ -942,6 +948,7 @@
 		break;
 	}
 
+unlock:
 	release_sock(sk);
 	if (needs_rtnl)
 		rtnl_unlock();
